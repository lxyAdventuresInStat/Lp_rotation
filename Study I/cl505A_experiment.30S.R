rm(list=ls());
library(doParallel)
library(lavaan)
library(gtools)
library(zoo)
library(GPArotation)

#setwd('C:/Users/LIUX114/OneDrive - London School of Economics/0501')
source('cl510_oblique_rotation_function.R')
sim = 500
N = 400 #800,1600
c_list<-c(seq(0,0.19,by=0.01),seq(0.2,2,by=0.1),3)
c_bic_list<-c(seq(0.02,0.4,by=0.02))
lambda_list<-c(seq(0.01,0.37,by=0.01),0.4,0.5,2)
t1=proc.time()

####30*5 SMALL--------------------------------------------------------------------------

  L<-matrix(c(0.71,0.00,0.00,0.00,0.00,
0.00,0.75,0.00,0.00,0.00,
0.00,0.00,0.83,0.00,0.00,
0.00,0.00,0.00,0.96,0.00,
0.00,0.00,0.00,0.00,0.68,
0.96,0.00,0.00,0.00,0.00,
0.00,0.98,0.00,0.00,0.00,
0.00,0.00,0.86,0.00,0.00,
0.00,0.00,0.00,0.85,0.00,
0.00,0.00,0.00,0.00,0.62,
0.68,0.00,0.00,0.00,0.00,
0.00,0.67,0.00,0.00,0.00,
0.00,0.00,0.87,0.00,0.00,
0.00,0.00,0.00,0.75,0.00,
0.00,0.00,0.00,0.00,0.91,
0.80,0.34,0.00,0.00,0.00,
0.00,0.89,0.38,0.00,0.00,
0.00,0.00,1.00,0.35,0.00,
0.00,0.00,0.00,0.75,0.26,
0.45,0.00,0.00,0.00,0.91,
0.97,0.00,0.40,0.00,0.00,
0.00,0.68,0.00,0.44,0.00,
0.00,0.00,0.86,0.00,0.23,
0.42,0.00,0.00,0.65,0.00,
0.00,0.32,0.00,0.00,0.71,
0.75,0.45,0.39,0.00,0.00,
0.00,0.61,0.43,0.37,0.00,
0.00,0.00,0.75,0.36,0.44,
0.34,0.00,0.00,0.95,0.21,
0.42,0.41,0.00,0.00,0.74),nrow<-30,ncol=5,byrow<-TRUE);

B<-matrix(c(1,0.08507226,0.429328611,0.1480261,0.24930445,
0,0.99637478,0.005627324,0.1368557,0.28840407,
0,0.00000000,0.903130819,0.4776413,0.01373041,
0,0.00000000,0.000000000,0.8551126,0.12494345,
0,0.00000000,0.000000000,0.0000000,0.91589901),5,5,byrow=TRUE)
#P<-c(0.23547415, 0.31635983, 0.45289140, 0.64616447, 0.18372218, 0.64100599, 0.66509501, 0.50729808, 0.48803634, 0.05995265, 0.18728802, 0.16259217,0.52296535, 0.32505280, 0.57088995, 0.40393009, 0.54093874, 0.68909202, 0.32210899, 0.57517706, 0.65995498, 0.19238947, 0.50178918, 0.11827633,0.23682605, 0.32650422, 0.01330147, 0.32381241, 0.62577309, 0.29293003)
P<-c(0.24,0.32,0.45,0.65,0.18,0.64,0.67,0.51,0.49,0.06,0.19,0.16,0.52,0.33,0.57,0.40,0.54,0.69,0.32,0.58,0.66,0.19,0.50,0.12,0.24,0.33,0.01,0.32,0.63,0.29)
#########################################################

n_row<- nrow(L)
n_col<- ncol(L)
Sig <- L%*%t(B)%*%B%*%t(L)+diag(exp(P))
(Sig)
(exp(P))
(t(B)%*%B)
L_old=L!=0
seed=0

############ Replicates
ncores=detectCores()
cl = makeCluster(ncores-1)
registerDoParallel(cl)

out = foreach(i = 1:sim, .packages = c("lavaan","gtools","zoo","GPArotation"), .errorhandling = "pass") %dopar%{
  set.seed(i)
  
  ## generate data
  SLP0=Gen.SLP(Sig,N,n_col)
  S=SLP0$S
  L_vari=SLP0$L_vari
  Psi_cfa=SLP0$Psi_cfa
  
  
  res=list()
  res$vari$L=permfilp(L_vari,L)
  res$vari$mse= mean((oblimin(L_vari)[[1]]-L)^2)
  
  
  ## irls p=1
  ans_est1<-irls(1,L_vari)
  res$irls1$L=L_est=permfilp(ans_est1$L,L)
  res$irls1$t=ans_est1$t
  res$irls1$it=ans_est1$it
  res$irls1$mse= mean((L_est-L)^2)
  #hard-thresholding
  ans_hard=hard(c_list,L_est,L_old)
  res$irls1$TPR =ans_hard$TPR
  res$irls1$TNR =ans_hard$TNR
  #res$irls1$AUC =ans_hard$AUC
  #bic-accuracy
  bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
  res$irls1$c= c = c_bic_list[which.min(bic)[1]]
  res$irls1$L_bic=L_bic=refit.L(c,L_est,S,N)
  res$irls1$L_bic.res=hard.each(c,L_est,L_old)
  #CI-coverage
  ans_ci=CI(L_bic,S,N,L)
  res$irls1$L_class=ans_ci$L_class
  res$irls1$ci.accuracy=ans_ci$ci.accuracy
  res$irls1$L_lower=ans_ci$L_lower
  res$irls1$L_upper=ans_ci$L_upper
  res$irls1$na.flag=ans_ci$na.flag
  
  #irls p=0.5
  ans_est<-irls(0.5,L_vari,T=ans_est1$T)
  res$irls0.5$L=L_est=permfilp(ans_est$L,L)
  res$irls0.5$t=ans_est$t
  res$irls0.5$it=ans_est$it
  res$irls0.5$mse= mean((L_est-L)^2)
  #hard-thresholding
  ans_hard=hard(c_list,L_est,L_old)
  res$irls0.5$TPR =ans_hard$TPR
  res$irls0.5$TNR =ans_hard$TNR
  #res$irls0.5$AUC =ans_hard$AUC
  #bic-accuracy
  bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
  res$irls0.5$c= c = c_bic_list[which.min(bic)[1]]
  res$irls0.5$L_bic=L_bic=refit.L(c,L_est,S,N)
  res$irls0.5$L_bic.res=hard.each(c,L_est,L_old)
  #CI-coverage
  ans_ci=CI(L_bic,S,N,L)
  res$irls0.5$L_class=ans_ci$L_class
  res$irls0.5$ci.accuracy=ans_ci$ci.accuracy
  res$irls0.5$L_lower=ans_ci$L_lower
  res$irls0.5$L_upper=ans_ci$L_upper
  res$irls0.5$na.flag=ans_ci$na.flag
  
  
  if(T){
    ## lasso.ap
    ans_est2<-prox_grad(L_vari,diag(rep(1,n_col)),log(Psi_cfa),S,0.01)
    res$lasso.ap0.01$L=L_est=permfilp(ans_est2$L,L)
    res$lasso.ap0.01$t=ans_est2$t
    res$lasso.ap0.01$it=ans_est2$it
    res$lasso.ap0.01$mse= mean((L_est-L)^2)
    #hard-thresholding
    ans_hard=hard(c_list,L_est,L_old)
    res$lasso.ap0.01$TPR =ans_hard$TPR
    res$lasso.ap0.01$TNR =ans_hard$TNR
    #res$lasso.ap$AUC =ans_hard$AUC
    #bic-accuracy
    bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
    res$lasso.ap0.01$c=c= c_bic_list[which.min(bic)[1]]
    res$lasso.ap0.01$L_bic=refit.L(c,L_est,S,N)
    res$lasso.ap0.01$L_bic.res=hard.each(c,L_est,L_old)
    
    
    ## lasso.ap
    ans_est3<-prox_grad(L_est,diag(rep(1,n_col)),log(Psi_cfa),S,0.05)
    res$lasso.ap0.05$L=L_est=permfilp(ans_est3$L,L)
    res$lasso.ap0.05$t=ans_est3$t
    res$lasso.ap0.05$it=ans_est3$it
    res$lasso.ap0.05$mse= mean((L_est-L)^2)
    #hard-thresholding
    ans_hard=hard(c_list,L_est,L_old)
    res$lasso.ap0.05$TPR =ans_hard$TPR
    res$lasso.ap0.05$TNR =ans_hard$TNR
    #res$lasso.ap0.05$AUC =ans_hard$AUC
    #bic-accuracy
    bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
    res$lasso.ap0.05$c=c= c_bic_list[which.min(bic)[1]]
    res$lasso.ap0.05$L_bic=refit.L(c,L_est,S,N)
    res$lasso.ap0.05$L_bic.res=hard.each(c,L_est,L_old)
    
    
    ## lasso.ap
    ans_est4<-prox_grad(L_est,diag(rep(1,n_col)),log(Psi_cfa),S,0.1)
    res$lasso.ap0.1$L=L_est=permfilp(ans_est4$L,L)
    res$lasso.ap0.1$t=ans_est4$t
    res$lasso.ap0.1$it=ans_est4$it
    res$lasso.ap0.1$mse= mean((L_est-L)^2)
    #hard-thresholding
    ans_hard=hard(c_list,L_est,L_old)
    res$lasso.ap0.1$TPR =ans_hard$TPR
    res$lasso.ap0.1$TNR =ans_hard$TNR
    #res$lasso.ap0.1$AUC =ans_hard$AUC
    #bic-accuracy
    bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
    res$lasso.ap0.1$c=c= c_bic_list[which.min(bic)[1]]
    res$lasso.ap0.1$L_bic=refit.L(c,L_est,S,N)
    res$lasso.ap0.1$L_bic.res=hard.each(c,L_est,L_old)
    
    ## lasso.ap
    ans_est5<-prox_grad(L_est,diag(rep(1,n_col)),log(Psi_cfa),S,0.2)
    res$lasso.ap0.2$L=L_est=permfilp(ans_est5$L,L)
    res$lasso.ap0.2$t=ans_est5$t
    res$lasso.ap0.2$it=ans_est5$it
    res$lasso.ap0.2$mse= mean((L_est-L)^2)
    #hard-thresholding
    ans_hard=hard(c_list,L_est,L_old)
    res$lasso.ap0.2$TPR =ans_hard$TPR
    res$lasso.ap0.2$TNR =ans_hard$TNR
    #res$lasso.ap0.2$AUC =ans_hard$AUC
    #bic-accuracy
    bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
    res$lasso.ap0.2$c=c= c_bic_list[which.min(bic)[1]]
    res$lasso.ap0.2$L_bic=refit.L(c,L_est,S,N)
    res$lasso.ap0.2$L_bic.res=hard.each(c,L_est,L_old)
    
    ans_est6<-prox_grad(L_est,diag(rep(1,n_col)),log(Psi_cfa),S,0.5)
    res$lasso.ap0.5$L=L_est=permfilp(ans_est6$L,L)
    res$lasso.ap0.5$t=ans_est6$t
    res$lasso.ap0.5$it=ans_est6$it
    res$lasso.ap0.5$mse= mean((L_est-L)^2)
    #hard-thresholding
    ans_hard=hard(c_list,L_est,L_old)
    res$lasso.ap0.5$TPR =ans_hard$TPR
    res$lasso.ap0.5$TNR =ans_hard$TNR
    #res$lasso.ap0.5$AUC =ans_hard$AUC
    #bic-accuracy
    bic=sapply(c_bic_list,refit.bic,L_irls=L_est,S=S,N=N)
    res$lasso.ap0.5$c=c= c_bic_list[which.min(bic)[1]]
    res$lasso.ap0.5$L_bic=refit.L(c,L_est,S,N)
    res$lasso.ap0.5$L_bic.res=hard.each(c,L_est,L_old)
  }
  return(res)
}
t=proc.time()[3]-t1[3]
save(out,L,B,P,sim,N,seed, t,file = paste0("0510A.30S_Fa_CI_p",nrow(L),"k",n_col,"nsim", sim,"nsample", N, ".RData"))

stopCluster(cl)